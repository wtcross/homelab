---
# Static quadlet base files
# These files have no templating and can eventually be moved to a separate repo
# or distributed via a package. For now, the role copies them.

- name: Ensure quadlet directories exist
  become: true
  ansible.builtin.file:
    state: directory
    path: "{{ item }}"
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
    mode: "0755"
  loop:
    - "{{ __step_user_home }}/.config/containers/systemd"
    - "{{ __step_user_home }}/.config/systemd/user"

- name: Copy static quadlet base files
  become: true
  ansible.builtin.copy:
    src: "systemd/quadlet/{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
    mode: "0644"
  loop:
    - src: step-ca@.container
      dest: "{{ __step_user_home }}/.config/containers/systemd/step-ca@.container"
    - src: step-ca@.volume
      dest: "{{ __step_user_home }}/.config/containers/systemd/step-ca@.volume"
    - src: step-ca.network
      dest: "{{ __step_user_home }}/.config/containers/systemd/step-ca.network"
    - src: step-ca@.target
      dest: "{{ __step_user_home }}/.config/systemd/user/step-ca@.target"
  notify:
    - Reload the user-level systemd daemon
    - Restart the step-ca instance

# Instance-specific configuration via drop-ins and environment files

- name: Ensure step-ca environment directory exists
  become: true
  ansible.builtin.file:
    state: directory
    path: "{{ __step_user_home }}/.config/step-ca"
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
    mode: "0750"

- name: Ensure step-ca instance environment file exists
  become: true
  ansible.builtin.copy:
    dest: "{{ __step_user_home }}/.config/step-ca/{{ _step_instance }}.env"
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
    mode: "0640"
    content: |
      STEPCA_INIT_NAME={{ step_name }}
      STEPCA_INIT_DNS_NAMES={{ step_dns_name }}
  notify:
    - Reload the user-level systemd daemon
    - Restart the step-ca instance

- name: Ensure step-ca container drop-in directory exists
  become: true
  ansible.builtin.file:
    state: directory
    path: "{{ __step_user_home }}/.config/containers/systemd/step-ca@{{ _step_instance }}.container.d"
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
    mode: "0755"

- name: Ensure step-ca port configuration drop-in exists
  become: true
  ansible.builtin.copy:
    dest: "{{ __step_user_home }}/.config/containers/systemd/step-ca@{{ _step_instance }}.container.d/10-ports.conf"
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
    mode: "0644"
    content: |
      [Container]
      PublishPort={{ _step_https_port }}:9000
  notify:
    - Reload the user-level systemd daemon
    - Restart the step-ca instance

- name: Ensure the step-ca instance is enabled and started
  become: true
  become_user: "{{ _step_user }}"
  environment:
    XDG_RUNTIME_DIR: /run/user/{{ _step_uid }}
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ _step_uid }}/bus"
  ansible.builtin.systemd_service:
    state: started
    enabled: true
    scope: user
    name: "step-ca@{{ _step_instance }}.target"
