apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: external-vm-cloud-init-userdata
  namespace: external-vms
spec:
  data:
    - remoteRef:
        key: lab-ca-bundle
      secretKey: labCABundle
    - remoteRef:
        key: rh-organization-id
      secretKey: rhOrganizationID
    - remoteRef:
        key: rhel-activation-key
      secretKey: rhelActivationKey
    - remoteRef:
        key: core-virt-ssh-management-ed25519-pub
      secretKey: sshManagementAuthorizedKey
  refreshInterval: 1h0m0s
  secretStoreRef:
    kind: ClusterSecretStore
    name: infra-gcpsm-store
  target:
    name: external-vm-cloud-init-userdata
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        userdata: |
          #cloud-config
          disable_root: true
          allow_public_ssh_keys: true

          users:
            - name: mgmt
              groups: wheel
              shell: /bin/bash
              lock_passwd: true
              sudo: ALL=(ALL) NOPASSWD:ALL
              ssh_authorized_keys:
                - {{ .sshManagementAuthorizedKey | trim }}

          ca_certs:
            remove_defaults: false
            trusted:
              - |
          {{ .labCABundle | indent 6 }}

          write_files:
            - path: /usr/local/sbin/setup-route-tables.sh
              permissions: '0755'
              owner: root:root
              content: |
                #!/usr/bin/env bash
                set -euo pipefail

                # Table numbers + names
                POD_TABLE=100
                POD_TABLE_NAME="pod-net"

                LAB_TABLE=102
                LAB_TABLE_NAME="lab-external"

                # Lab network info
                LAB_NET="192.168.12.0/24"
                LAB_GW="192.168.12.1"
                DEST_NET="192.168.10.0/24"

                # 1) Ensure both tables are named in /etc/iproute2/rt_tables
                for entry in "$POD_TABLE $POD_TABLE_NAME" "$LAB_TABLE $LAB_TABLE_NAME"; do
                  TNUM="${entry%% *}"
                  TNAME="${entry#* }"

                  if ! grep -qE "^[[:space:]]*$TNUM[[:space:]]+$TNAME" /etc/iproute2/rt_tables 2>/dev/null; then
                    echo "$TNUM $TNAME" >> /etc/iproute2/rt_tables
                  fi
                done

                # 2) Find the lab interface (one that has 192.168.12.x)
                LAB_IF=$(ip -4 -o addr show | awk '/inet 192\.168\.12\./ {print $2; exit}')

                if [ -z "$LAB_IF" ]; then
                  echo "setup-route-tables: no interface with 192.168.12.x address found, nothing to do"
                  exit 0
                fi

                LAB_IP_CIDR=$(ip -4 -o addr show dev "$LAB_IF" | awk '/inet 192\.168\.12\./ {print $4; exit}')
                LAB_IP="${LAB_IP_CIDR%%/*}"

                echo "setup-route-tables: using interface $LAB_IF (IP $LAB_IP) for $LAB_NET via $LAB_GW (table $LAB_TABLE_NAME:$LAB_TABLE)"

                # 3) Ensure LAB table (102) has routes

                # On-link route for 192.168.12.0/24
                ip route show table "$LAB_TABLE" | grep -q "^$LAB_NET " \
                  || ip route replace "$LAB_NET" dev "$LAB_IF" table "$LAB_TABLE"

                # Default via 192.168.12.1 on LAB_IF
                ip route show table "$LAB_TABLE" | grep -q "^default via $LAB_GW dev $LAB_IF" \
                  || ip route replace default via "$LAB_GW" dev "$LAB_IF" table "$LAB_TABLE"

                # 4) Policy rules for LAB table:
                #    - any traffic TO 192.168.10.0/24 uses LAB_TABLE
                #    - any traffic FROM 192.168.12.0/24 uses LAB_TABLE

                if ! ip rule show | grep -q "to $DEST_NET.*lookup $LAB_TABLE"; then
                  ip rule add priority 90 to "$DEST_NET" table "$LAB_TABLE"
                fi

                if ! ip rule show | grep -q "from $LAB_NET.*lookup $LAB_TABLE"; then
                  ip rule add priority "$LAB_TABLE" from "$LAB_NET" table "$LAB_TABLE"
                fi

                echo "setup-route-tables: LAB table $LAB_TABLE_NAME ($LAB_TABLE) and rules are configured"

            - path: /usr/local/sbin/rh-subscribe.sh
              permissions: '0755'
              owner: root:root
              content: |
                #!/bin/bash
                set -euo pipefail

                readonly ORG_ID="{{ .rhOrganizationID | trim }}"
                readonly ACTIVATION_KEY="{{ .rhelActivationKey | trim }}"

                log() {
                  # Log to stderr so cloud-init captures it in /var/log/cloud-init-output.log
                  echo "[rhc-register] $*" >&2
                }

                # Ensure rhc is available
                if ! command -v rhc >/dev/null 2>&1; then
                  log "rhc not found in PATH; skipping registration."
                  exit 0
                fi

                # Ensure subscription-manager is available
                if ! command -v subscription-manager >/dev/null 2>&1; then
                  log "subscription-manager not found; cannot determine registration state. Skipping."
                  exit 0
                fi

                # Check if the system is already registered
                # subscription-manager identity exits 0 when registered, non-zero otherwise.
                if subscription-manager identity >/dev/null 2>&1; then
                  log "System already registered with Red Hat; nothing to do."
                  exit 0
                fi

                if [[ -z "${ORG_ID}" || -z "${ACTIVATION_KEY}" ]]; then
                  log "ORG_ID or ACTIVATION_KEY is empty; refusing to attempt registration."
                  exit 1
                fi

                log "System not registered; attempting registration via rhc..."

                # Register the system with rhc using activation key + org ID
                if rhc connect \
                      --activation-key="${ACTIVATION_KEY}" \
                      --organization="${ORG_ID}"; then
                  log "Registration via rhc completed successfully."
                else
                  rc=$?
                  log "rhc connect failed with exit code ${rc}."
                  exit "${rc}"
                fi

          runcmd:
            - /usr/local/sbin/setup-route-tables.sh
            - /usr/local/sbin/rh-subscribe.sh
