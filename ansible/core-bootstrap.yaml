- name: Bootstrap the cluster with OpenShift GitOps
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tasks:
    - name: Install the OpenShift GitOps operator
      command: oc apply -k ../openshift-gitops/components/bootstrap/openshift-gitops-operator/operator/overlays/default
      register: install_gitops_operator
      changed_when: "'configured' in install_gitops_operator.stdout or 'created' in install_gitops_operator.stdout"

    - name: Wait until the GitOps operator reaches the desired status
      kubernetes.core.k8s_info:
        api_version: argoproj.io/v1beta1
        namespace: openshift-gitops
        kind: ArgoCD
        name: openshift-gitops
      register: gitops_operator
      retries: 30
      delay: 5
      until: gitops_operator.status.phase == 'Available'

    - name: Deploy a ArgoCD instance
      command: oc apply -k ../openshift-gitops/components/bootstrap/openshift-gitops-operator/instance/overlays/default
      register: deploy_argocd_instance
      changed_when: "'configured' in deploy_argocd_instance.stdout or 'created' in deploy_argocd_instance.stdout"

    - name: Wait until the ArgoCD instance reaches Available phase
      kubernetes.core.k8s_info:
        api_version: argoproj.io/v1beta1
        namespace: openshift-gitops
        kind: ArgoCD
        name: openshift-gitops
      register: argocd
      retries: 30
      delay: 5
      until: >
        argocd.resources | length > 0 and
        argocd.resources[0].status.phase == 'Available'

    - name: Create the external-secrets namespace
      kubernetes.core.k8s:
        name: external-secrets
        api_version: v1
        kind: Namespace
        state: present

    - name: Create the GCP access credentials secret
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name:  infra-secrets-reader-credentials
            namespace: external-secrets
          data:
            secret-access-credentials: "{{ lookup('ansible.builtin.file', gcp_credential_path) | ansible.builtin.b64encode }}"
          type: Opaque
      vars:
        gcp_credential_path: "{{ lookup('ansible.builtin.env', 'INFRA_SECRET_CREDENTIAL_PATH') }}"

    - name: Create the boostrap application
      command: oc apply -k ../openshift-gitops/argocd
      register: create_bootstrap_application
      changed_when: "'configured' in create_bootstrap_application.stdout or 'created' in create_bootstrap_application.stdout"
