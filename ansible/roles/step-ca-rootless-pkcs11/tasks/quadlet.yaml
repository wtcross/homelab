---
- name: Create a selinux policy specific to step-ca for accessing the p11-kit server socket
  block:
    - name: Create a directory for storing SELinux CIL files
      become: true
      ansible.builtin.file:
        state: directory
        path: /var/lib/udica/policy/
        owner: root
        group: root
        mode: "0755"

    - name: Copy SELinux CIL file for custom step-ca policy
      become: true
      ansible.builtin.copy:
        src: step_ca_policy.cil
        dest: /var/lib/udica/policy/step_ca_policy.cil
        owner: root
        group: root
        mode: "0755"

    - name: Ensure custom step-ca SELinux policy is installed
      become: true
      ansible.builtin.command:
        cmd: >
          /sbin/semodule
          -i step_ca_policy.cil
          /usr/share/udica/templates/base_container.cil
          /usr/share/udica/templates/net_container.cil
        chdir: /var/lib/udica/policy
      register: install_custom_selinux_policies

- name: Create a podman secret for the HSM PIN
  block:
    - name: Check if the podman secret for the HSM PIN exists
      become: true
      become_user: "{{ _step_user }}"
      ansible.builtin.command:
        cmd: "podman secret exists hsm-pin-{{ _step_instance }}"
      register: check_podman_secret_hsm_pin
      ignore_errors: true
      changed_when: false

    - name: Prompt for the HSM PIN if it is not set yet
      when: check_podman_secret_hsm_pin.rc == 1
      become: false
      delegate_to: localhost
      ansible.builtin.pause:
        prompt: "Enter the HSM PIN for {{ step_name }}"
        echo: false
      register: hsm_pin_prompt

    - name: Create a podman secret for the HSM PIN
      when: check_podman_secret_hsm_pin.rc == 1
      become: true
      become_user: "{{ _step_user }}"
      containers.podman.podman_secret:
        state: present
        name: "hsm-pin-{{ _step_instance }}"
        data: "{{ hsm_pin_prompt.user_input }}"
        skip_existing: true

    - name: Clear HSM PIN from memory
      ansible.builtin.set_fact:
        hsm_pin_prompt: null

# Static quadlet base files
# These files have no templating and can eventually be moved to a separate repo
# or distributed via a package. For now, the role copies them.

- name: Ensure quadlet directories exist
  become: true
  ansible.builtin.file:
    state: directory
    path: "{{ item }}"
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
    mode: "0755"
  loop:
    - "{{ __step_user_home }}/.config/containers/systemd"
    - "{{ __step_user_home }}/.config/systemd/user"

- name: Copy static quadlet base files
  become: true
  ansible.builtin.copy:
    src: "systemd/quadlet/{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
    mode: "0644"
  loop:
    - src: step-ca@.container
      dest: "{{ __step_user_home }}/.config/containers/systemd/step-ca@.container"
    - src: step-ca@.volume
      dest: "{{ __step_user_home }}/.config/containers/systemd/step-ca@.volume"
    - src: step-ca.network
      dest: "{{ __step_user_home }}/.config/containers/systemd/step-ca.network"
    - src: step-ca@.target
      dest: "{{ __step_user_home }}/.config/systemd/user/step-ca@.target"
  register: copy_static_quadlet_files

# Instance-specific configuration via drop-ins and environment files

- name: Ensure step-ca environment directory exists
  become: true
  ansible.builtin.file:
    state: directory
    path: "{{ __step_user_home }}/.config/step-ca"
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
    mode: "0750"

- name: Ensure step-ca instance environment file exists
  become: true
  ansible.builtin.copy:
    dest: "{{ __step_user_home }}/.config/step-ca/{{ _step_instance }}.env"
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
    mode: "0640"
    content: |
      STEPCA_INIT_NAME={{ step_name }}
      STEPCA_INIT_DNS_NAMES={{ step_dns_name }}
  register: create_step_env

- name: Ensure step-ca container drop-in directory exists
  become: true
  ansible.builtin.file:
    state: directory
    path: "{{ __step_user_home }}/.config/containers/systemd/step-ca@{{ _step_instance }}.container.d"
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
    mode: "0755"

- name: Ensure step-ca port configuration drop-in exists
  become: true
  ansible.builtin.copy:
    dest: "{{ __step_user_home }}/.config/containers/systemd/step-ca@{{ _step_instance }}.container.d/10-ports.conf"
    owner: "{{ _step_user }}"
    group: "{{ _step_group }}"
    mode: "0644"
    content: |
      [Container]
      PublishPort={{ _step_https_port }}:9000
  register: create_step_port_dropin

- name: Reload the user-level systemd daemon if configuration changed
  when: copy_static_quadlet_files.changed or create_step_env.changed or create_step_port_dropin.changed
  become: true
  become_user: "{{ _step_user }}"
  environment:
    XDG_RUNTIME_DIR: /run/user/{{ _step_uid }}
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ _step_uid }}/bus"
  ansible.builtin.systemd_service:
    daemon_reload: true
    scope: user

- name: Restart the step-ca instance if configuration changed
  when: copy_static_quadlet_files.changed or create_step_env.changed or create_step_port_dropin.changed
  become: true
  become_user: "{{ _step_user }}"
  environment:
    XDG_RUNTIME_DIR: /run/user/{{ _step_uid }}
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ _step_uid }}/bus"
  ansible.builtin.systemd_service:
    state: restarted
    scope: user
    name: "step-ca@{{ _step_instance }}.target"

- name: Ensure the step-ca instance is enabled and started
  become: true
  become_user: "{{ _step_user }}"
  environment:
    XDG_RUNTIME_DIR: /run/user/{{ _step_uid }}
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ _step_uid }}/bus"
  ansible.builtin.systemd_service:
    state: started
    enabled: true
    scope: user
    name: "step-ca@{{ _step_instance }}.target"
